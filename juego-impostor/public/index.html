<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>El Impostor - Jorge EstefanÃ­a</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00a8ff">
    <link rel="apple-touch-icon" href="icon-192.ico">
</head>

<body>
    <div id="screen-loading">
        <h1>El Impostor</h1>
        <div class="loader"></div>
        <h2 class="animate-pop">Cargando...</h2>
        <small style="color:#bdc3c7; margin-top:10px;">Preparando todo</small>
    </div>

    <div id="screen-home" class="container hidden">
        <h1>ğŸ•µï¸ El Impostor</h1>

        <div id="active-tournament-display" class="tournament-active-banner hidden"
            style="flex-direction: column; align-items: stretch; gap: 0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>ğŸ† TORNEO EN CURSO</strong><br>
                    <small id="active-tourney-name">Copa...</small>
                </div>
                <button class="btn-secondary"
                    style="background:rgba(0,0,0,0.3); width:auto; margin:0; font-size:0.8em; padding: 5px 12px;"
                    onclick="finishTournament()">ğŸ FINALIZAR</button>
            </div>
            <div id="tournament-mini-scores" class="mini-scores-scroll">
            </div>
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 15px;">
            <button class="btn-text" onclick="loadAndShowStats()">ğŸ“Š Stats</button>
            <button class="btn-text" onclick="showHowToPlay()">â“ CÃ³mo jugar</button>
            <button class="btn-text" onclick="loadAndShowHistory()">ğŸ“œ Historial</button>
        </div>

        <div class="card">
            <h3>ğŸ‘¥ Jugadores</h3>
            <div id="players-list" class="tags-container"></div>
            <div class="input-row">
                <input type="text" id="new-player" placeholder="Nombre...">
                <button onclick="addPlayer()" class="btn-icon">+</button>
            </div>
        </div>

        <div class="card">
            <h3>âš™ï¸ ConfiguraciÃ³n</h3>
            <div style="margin-bottom: 20px;">
                <label>Impostores: <span id="impostor-val">1</span></label>
                <input type="range" id="impostor-count" min="1" max="3" value="1" oninput="updateConfigDisplay()">
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <strong style="font-size: 1.1em;">ğŸ’¡ Pistas Impostor</strong><br>
                    <small style="color: #bdc3c7;">Ayuda para disimular</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="hints-toggle" checked>
                    <span class="slider round"></span>
                </label>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <strong style="font-size: 1.1em;">ğŸ¤ CÃ³mplice</strong><br>
                    <small style="color: #bdc3c7;">Ayuda al impostor (MÃ­n 4 jug.)</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="accomplice-toggle">
                    <span class="slider round"></span>
                </label>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <strong style="font-size: 1.1em;">ğŸ‘† Modo Tutorial</strong><br>
                    <small style="color: #bdc3c7;">GuÃ­a visual con ayuda interactiva</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="tutorial-mode-toggle" onchange="toggleTutorialMode(this)">
                    <span class="slider round"></span>
                </label>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong>Sistema de Puntos</strong>
                    <div id="mode-description" style="font-size:0.8em; color:#bdc3c7; margin-top:2px;">
                        <span style="color:#2ecc71">â³ Supervivencia</span> <br><small style="opacity:0.7">El impostor
                            gana
                            mÃ¡s puntos por sobrevivir sin ser descubierto.<br>Activar este modo si el impostor gana
                            frecuentemente.</small>
                    </div>
                </div>

                <label class="switch">
                    <input type="checkbox" id="scoring-mode-toggle" onchange="toggleScoringMode(this)">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <button class="btn-main" onclick="goToThemeSelection()">JUGAR RONDA</button>

        <div class="tournament-box" id="tournament-setup-box">
            <h3 style="margin-top:0; color:#f1c40f;">ğŸ† Modo Torneo</h3>
            <p style="font-size:0.9em; color:#bdc3c7; margin-bottom:10px;">Acumula puntos y guarda el resultado
                agrupado.</p>
            <div class="input-row">
                <input type="text" id="tournament-name-input" placeholder="Nombre (Ej: Copa Viernes)">
                <button class="btn-main" style="background:#f1c40f; color:#2c3e50; margin:0; width:auto;"
                    onclick="startTournamentMode()">EMPEZAR</button>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <button class="btn-secondary" onclick="goToThemeManager()">âš™ï¸ GESTIÃ“N DE TEMAS</button>
        </div>


        <footer class="credits-footer">
            <div style="margin-bottom: 15px;">
                <a href="https://ko-fi.com/jorge_estefania" target="_blank" class="bmc-link">
                    <div class="bmc-button">
                        <span style="font-size: 1.2em; margin-right: 5px;">â˜•</span>
                        Invitame a un cafÃ©
                    </div>
                </a>
            </div>

            <p>Desarrollado por <a href="https://github.com/jaestefaniah27" target="_blank">Jorge EstefanÃ­a</a>
            </p>

            <small>v2.1 â€¢ El Impostor - Jorge EstefanÃ­a</small>
        </footer>
    </div>

    <div id="screen-how-to-play" class="container hidden">
        <h2>â“ CÃ³mo se juega</h2>
        <div class="card tutorial-card">
            <h3 style="border:none; color:var(--accent);">ğŸš€ Tutorial RÃ¡pido</h3>
            <div class="step">
                <strong>1ï¸âƒ£ Configura la partida:</strong> <br>AÃ±ade a los jugadores y elige el nÃºmero de impostores.
            </div>
            <div class="step">
                <strong>2ï¸âƒ£ Pasa el mÃ³vil:</strong> <br>Cada jugador debe ver su carta en secreto manteniendo pulsada la
                pantalla.
            </div>
            <div class="step">
                <strong>3ï¸âƒ£ Â¡Debate!:</strong> <br>Los ciudadanos deben encontrar al impostor haciendo preguntas sobre
                la
                palabra secreta.
            </div>
            <div class="step">
                <strong>4ï¸âƒ£ Vota:</strong> <br>Cuando los ciudadanos acuerden votar a alguien, <strong>pulsa el nombre
                    de
                    ese jugador</strong> y este serÃ¡ expulsado, revelando si era el impostor o no.
            </div>
        </div>

        <div class="card tutorial-card" style="border-left-color: #e67e22;">
            <h3 style="border:none; color:#e67e22;">âœ¨ Ãšltima oportunidad</h3>
            <p style="font-size: 0.9em; line-height: 1.4; color: #bdc3c7;">
                Si el impostor es descubierto por votaciÃ³n, Â¡no todo estÃ¡ perdido! Tiene una <strong>Ãºltima
                    oportunidad</strong> para ganar: debe adivinar la palabra secreta que tenÃ­an los ciudadanos.
            </p>
        </div>

        <div class="card tutorial-card" style="border-left-color: #f1c40f;">
            <h3 style="border:none; color:#f1c40f;">ğŸ“œ Reglas del Juego</h3>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>ğŸ“ˆ PuntuaciÃ³n:</strong> <br>El impostor gana mÃ¡s puntos cuantas mÃ¡s rondas aguante. Los
                ciudadanos consiguen
                menos puntos cuantas mÃ¡s rondas aguante el impostor.
            </div>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>ğŸ’¥ Victoria InstantÃ¡nea:</strong> <br>Si el impostor, durante su turno, dice la palabra secreta
                o una palabra de la misma raÃ­z semÃ¡ntica, <strong>gana automÃ¡ticamente</strong>. En este caso, pulsa el
                botÃ³n "Rendirse (gana impostor)".
            </div>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>ğŸš« ProhibiciÃ³n:</strong> <br>Los ciudadanos tienen <strong>totalmente prohibido</strong> decir
                la palabra secreta.
            </div>
        </div>

        <div class="card tutorial-card" style="border-left-color: #f1c40f;">
            <h3 style="border:none; color:#f1c40f;">ğŸ† Modo Torneo</h3>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>AcumulaciÃ³n de Puntos:</strong> <br>Este modo permite jugar varias rondas seguidas guardando el
                progreso. Ãštil para partidas largas con grupos de amigos.
            </div>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>ğŸ“Š Marcador:</strong> <br>Puedes ver la puntuaciÃ³n de cada jugador directamente en el banner del
                menÃº principal mientras el torneo estÃ© activo.
            </div>
            <div class="step" style="border-left-color: #f1c40f;">
                <strong>âš–ï¸ Sistemas de Puntos:</strong> <br>
                â€¢ <strong>ğŸ¥· Supervivencia:</strong> MÃ¡s puntos para el impostor si sobrevive. (Usar si el impostor
                suele
                ganar). <br>
                â€¢ <strong>â˜ ï¸ Alto riesgo:</strong> MÃ¡s puntos para el impostor si adivina la palabra. (Usar si los
                ciudadanos suelen ganar).
            </div>
        </div>

        <div class="fixed-bottom-bar">
            <button class="btn-secondary" style="margin:0; width:100%; max-width:500px;" onclick="goToHome()">ğŸ  VOLVER
                AL INICIO</button>
        </div>
    </div>

    <div id="screen-history" class="container hidden">
        <h2>ğŸ“œ Historial</h2>
        <div id="history-list"></div>
        <div class="fixed-bottom-bar">
            <button class="btn-secondary" style="margin:0; width:100%; max-width:500px;" onclick="goToHome()">ğŸ  VOLVER
                AL INICIO</button>
        </div>
    </div>
    <div id="screen-theme-manager" class="container hidden" style="padding-bottom: 100px;">
        <h2>Gestor de Temas</h2>
        <p style="font-size:0.9em; color:#bdc3c7; margin-bottom:20px;">Toca un tema para editarlo o crea uno nuevo.</p>

        <div id="manager-list" class="grid-container"></div>

        <div class="fixed-bottom-bar" style="flex-direction: column; gap: 10px;">
            <button class="btn-main" style="margin:0;" onclick="openThemeCreator()">â• CREAR TEMA NUEVO</button>
            <button class="btn-secondary" style="margin:0;" onclick="goToHome()">Volver al MenÃº</button>
        </div>
    </div>

    <div id="screen-create-theme" class="container hidden">
        <h2 id="create-theme-title">ğŸ¨ Nuevo Tema</h2>
        <div class="card">
            <label>TÃ­tulo:</label>
            <input type="text" id="new-theme-title" placeholder="Ej: SuperhÃ©roes">
            <div style="margin-top:10px;">
                <label>Preguntas Sugeridas (Opcional):</label>
                <small style="color:#bdc3c7; display:block; margin-bottom:5px;">SepÃ¡ralas con una barra "/"</small>
                <textarea id="new-theme-suggestions" placeholder="Â¿Tiene capa? / Â¿Vuela? / Â¿Es de Marvel?"
                    rows="3"></textarea>
            </div>
        </div>
        <div id="words-container"></div>
        <button class="btn-secondary" onclick="addWordRow()">+ AÃ±adir Palabra</button>
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button class="btn-secondary" style="background: #e74c3c;" onclick="goToThemeManager()">Cancelar</button>
            <button class="btn-main" onclick="saveThemeFromUI()">Guardar</button>
        </div>
    </div>

    <div id="screen-themes" class="container hidden" style="padding-bottom: 130px;">
        <h2>Elige Temas</h2>
        <div id="themes-grid" class="grid-container"></div>
        <div class="fixed-bottom-bar" style="flex-direction: column; gap: 5px;">
            <button class="btn-main" style="margin:0;" onclick="startGameSetup()">Â¡EMPEZAR!</button>
            <button class="btn-secondary" style="margin:0;" onclick="showScreen('screen-home')">Volver</button>
        </div>
    </div>

    <div id="screen-pass-device" class="container hidden full-height">

        <div style="flex: 1; display: flex; align-items: center; justify-content: center; width: 100%;">
            <div class="card" style="text-align: center; padding: 40px 20px; width: 100%; max-width: 400px;">
                <div id="pass-player-avatar" style="font-size: 4em; margin-bottom: 10px;">ğŸ‘¤</div>
                <h3 style="color: #bdc3c7; margin: 0;">PÃ¡sale el mÃ³vil a:</h3>
                <h1 id="pass-player-name" style="font-size: 2.5em; margin: 15px 0; color: var(--accent);">Nombre</h1>
                <p style="margin-bottom: 30px; opacity: 0.7;">No mires si no eres tÃº</p>
                <button class="btn-main" onclick="confirmIdentity()">Â¡SOY YO, VER MI CARTA!</button>
            </div>
        </div>

        <button class="btn-text" onclick="cancelGame()"
            style="margin-bottom: 20px; color: #bdc3c7; opacity: 0.8;">Cancelar partida</button>
    </div>

    <div id="screen-reveal" class="container hidden full-height">

        <div
            style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
            <h2 id="current-player-display" style="margin-top: 0;">Nombre</h2>
            <p class="instruction" style="margin-bottom: 20px;">MantÃ©n pulsada la carta</p>

            <div class="magic-card-container" id="magic-card">
                <div class="card-content">
                    <div id="secret-word" class="secret-text">...</div>
                    <div id="secret-role" class="role-subtext"></div>
                </div>
                <div class="card-cover"><span>ğŸ‘† MANTENER PULSADO</span></div>
            </div>
        </div>

        <div style="width: 100%; margin-bottom: 20px; display: flex; flex-direction: column; gap: 45px;">
            <button id="next-btn" class="btn-main" onclick="nextPlayer()" style="margin: 0;">SIGUIENTE</button>
            <button class="btn-text" onclick="cancelGame()" style="color: #bdc3c7; opacity: 0.8;">Cancelar
                partida</button>
        </div>
    </div>

    <div id="screen-active" class="container hidden">
        <div class="card" style="background: #233642; border: 1px solid var(--accent); text-align: center;">
            <p style="margin:0; font-size: 0.9em; color: #bdc3c7;">DEBE EMPEZAR HABLANDO:</p>
            <h2 id="starter-name" style="margin: 5px 0; font-size: 1.8em; color: #f1c40f;">...</h2>
        </div>
        <div id="timer-display" class="timer-big">10:00</div>
        <div id="suggestion-area"></div>
        <button class="btn-secondary" onclick="showSuggestion()" style="margin-bottom: 20px;">â“ Â¿QuÃ© pregunto?
            (Sugerencia)</button>
        <h3>Votar ExpulsiÃ³n</h3>
        <div id="voting-list" class="voting-grid"></div>
        <div style="width: 100%; margin-bottom: 20px; display: flex; flex-direction: column; gap: 45px;">
            <button class="btn-secondary bottom-btn" onclick="citizensGiveUp()">RENDIRSE (Gana Impostor)</button>
            <button class="btn-text" onclick="cancelGame()" style="margin-top: 20px; color: #bdc3c7;">Cancelar
                partida</button>
        </div>
    </div>
    <div id="screen-result" class="container hidden full-height">
        <h1 id="result-title">...</h1>
        <div id="result-icon" style="font-size: 5em; margin: 20px;"></div>
        <p id="result-msg" style="font-size: 1.2em;"></p>
        <div id="impostor-guess-area" class="hidden">
            <p style="color:var(--accent)">Â¡Oportunidad de robo! Â¿Adivina la palabra?</p>
            <div style="display: grid; gap: 10px;">
                <button class="btn-main" style="background: #e74c3c;" onclick="endGameWithWinner('Impostor')">âœ… SÃ (Gana
                    Impostor)</button>
                <button class="btn-secondary" onclick="endGameWithWinner('Ciudadanos')">âŒ NO (Ganan Ciudadanos)</button>
            </div>
        </div>
        <button id="continue-btn" class="btn-main hidden" onclick="continueGame()">SEGUIR JUGANDO</button>
    </div>

    <div id="screen-solution" class="container hidden full-height">
        <h1 id="final-result-title">FIN DE RONDA</h1>
        <div class="card">
            <h3>Palabra Secreta:</h3>
            <h1 style="color:var(--accent); font-size:3em; margin:10px 0;" id="final-word">???</h1>
        </div>
        <p id="winner-display" style="font-size: 1.5em; font-weight: bold; margin: 10px 0;"></p>
        <div id="roles-reveal" style="margin-bottom: 20px;"></div>
        <div id="scoreboard-container" class="card hidden">
            <h3>ğŸ† ClasificaciÃ³n - <span id="score-tourney-name"></span></h3>
            <table class="scoreboard-table" id="scoreboard-body"></table>
        </div>
        <button class="btn-main" onclick="restartGame()">ğŸ”„ SIGUIENTE RONDA</button>
        <button class="btn-secondary" onclick="exitGameToHome()">VOLVER AL MENÃš</button>
    </div>
    <div id="screen-history" class="container hidden">
        <h2>ğŸ“œ Historial</h2>
        <div id="history-list"></div>
        <div class="fixed-bottom-bar">
            <button class="btn-secondary" style="margin:0; width:100%; max-width:500px;" onclick="goToHome()">ğŸ  VOLVER
                AL INICIO</button>
        </div>
    </div>

    <div id="screen-stats" class="container hidden" style="padding-bottom: 100px;">
        <h2>ğŸ“Š Stats</h2>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
            <div class="card" style="text-align:center; background: #2c3e50; margin:0;">
                <div style="font-size:2em;">ğŸ¥·</div>
                <small style="color:#e74c3c">Mejor Impostor</small>
                <div id="stat-best-impostor" style="font-weight:bold; color:white;">-</div>
            </div>
            <div class="card" style="text-align:center; background: #2c3e50; margin:0;">
                <div style="font-size:2em;">ğŸ®</div>
                <small style="color:#3498db">MÃ¡s Viciado</small>
                <div id="stat-most-played" style="font-weight:bold; color:white;">-</div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:5px;">ğŸ“Š Globales</h3>
            <p>Partidas Totales: <strong id="stat-total-games" style="color:var(--accent)">0</strong></p>
            <p>Tiempo de Juego: <strong id="stat-total-time" style="color:var(--accent)">0h 0m</strong></p>
        </div>

        <div id="merge-tool-bar" class="card hidden"
            style="background:#e67e22; position:sticky; top:10px; z-index:100; animation: popIn 0.3s;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="color:white; font-weight:bold;">Gestor de Nombres</span>
                <button class="btn-secondary"
                    style="background:rgba(0,0,0,0.2); width:auto; padding:5px 10px; margin:0;"
                    onclick="cancelMergeMode()">Cancelar</button>
            </div>
            <p style="font-size:0.8em; margin:5px 0 10px 0; color:white;">
                - Selecciona 2+ para <strong>UNIFICAR</strong>.<br>
                - Selecciona 1 (con alias) para <strong>DESUNIFICAR</strong>.
            </p>
            <button id="merge-action-btn" class="btn-main"
                style="background:white; color:#d35400; margin:0; padding:10px;" disabled>Selecciona
                jugadores...</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>Ranking Jugadores</h3>
            <button class="btn-text" style="font-size:0.8em;" onclick="toggleMergeMode()">ğŸ”— Unificar Nombres</button>
        </div>

        <div id="stats-list"></div>

        <div class="fixed-bottom-bar">
            <button class="btn-secondary" style="margin:0; width:100%; max-width:500px;" onclick="goToHome()">ğŸ  VOLVER
                AL INICIO</button>
        </div>
    </div>

    <div id="tutorial-guide-layer" class="tutorial-overlay hidden">
        <div class="finger-guide">ğŸ‘†</div>
    </div>

    <script src="js/data.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registrado âœ…', reg))
                    .catch(err => console.log('SW error âŒ', err));
            });
        }
    </script>
</body>

</html>