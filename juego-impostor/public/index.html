<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>El Impostor Pro</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos extra para el historial */
        .history-item {
            background: #2f3640;
            border-left: 5px solid #7f8fa6;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
            border-radius: 5px;
        }
        .history-item.win-impostor { border-left-color: #e74c3c; } /* Rojo si gana impostor */
        .history-item.win-citizens { border-left-color: #2ecc71; } /* Verde si ganan ciudadanos */
        
        .history-details {
            font-size: 0.9em;
            color: #bdc3c7;
            margin-top: 5px;
        }
        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .badge-imp { background: #e74c3c; color: white; }
    </style>
</head>
<body>

    <div id="screen-home" class="container">
        <h1>üïµÔ∏è El Impostor</h1>
        
        <div style="text-align: right; margin-bottom: 10px;">
            <button class="btn-text" onclick="loadAndShowHistory()">üìú Ver Historial de Partidas</button>
        </div>

        <div class="card">
            <h3>üë• Jugadores</h3>
            <div id="players-list" class="tags-container"></div>
            <div class="input-row">
                <input type="text" id="new-player" placeholder="Nombre...">
                <button onclick="addPlayer()" class="btn-icon">+</button>
            </div>
        </div>

        <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin-bottom: 5px; border: none;">üí° Pistas Impostor</h3>
                <small style="color: #bdc3c7;">Ayuda para disimular</small>
            </div>
            <label class="switch">
                <input type="checkbox" id="hints-toggle" checked>
                <span class="slider round"></span>
            </label>
        </div>

        <div class="card">
            <h3>‚è±Ô∏è Duraci√≥n Partida</h3>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <input type="range" id="game-timer-input" min="5" max="21" value="10" step="1" oninput="updateTimeDisplay()" style="width:70%">
                <span id="time-display" style="font-weight:bold; color:var(--accent)">10 min</span>
            </div>
        </div>

        <div class="card">
            <h3>‚öôÔ∏è Impostores</h3>
            <label>Cantidad: <span id="impostor-val">1</span></label>
            <input type="range" id="impostor-count" min="1" max="3" value="1" oninput="updateConfigDisplay()">
        </div>

        <button class="btn-main" onclick="goToThemeSelection()">JUGAR</button>
        
        <div style="margin-top: 20px;">
            <p class="instruction">¬øQuieres jugar con tus propias palabras?</p>
            <button class="btn-secondary" onclick="openThemeCreator()">üé® CREADOR DE TEMAS</button>
        </div>
    </div>

    <div id="screen-history" class="container hidden">
        <h2>üìú Historial de Partidas</h2>
        <div id="history-list">
            </div>
        <button class="btn-secondary" onclick="goToHome()">üè† Volver al Inicio</button>
    </div>

    <div id="screen-create-theme" class="container hidden">
        <h2>üé® Nuevo Tema</h2>
        <div class="card">
            <label>T√≠tulo del Tema:</label>
            <input type="text" id="new-theme-title" placeholder="Ej: Superh√©roes">
        </div>
        <div id="words-container"></div>
        <button class="btn-secondary" onclick="addWordRow()">+ A√ëADIR PALABRA</button>
        <div style="margin-top: 30px; display: flex; gap: 10px;">
            <button class="btn-secondary" style="background: #e74c3c;" onclick="showScreen('screen-home')">Cancelar</button>
            <button class="btn-main" onclick="saveThemeFromUI()">GUARDAR TEMA</button>
        </div>
    </div>

    <div id="screen-themes" class="container hidden">
        <h2>Elige Temas</h2>
        <div id="themes-grid" class="grid-container"></div>
        <button class="btn-main" onclick="startGameSetup()">¬°EMPEZAR!</button>
        <button class="btn-text" onclick="showScreen('screen-home')">Volver</button>
    </div>

    <div id="screen-reveal" class="container hidden full-height">
        <h2 id="current-player-display">Nombre</h2>
        <p class="instruction">Mant√©n pulsada la carta para ver</p>
        <div class="magic-card-container" id="magic-card">
            <div class="card-content">
                <div id="secret-word" class="secret-text">...</div>
                <div id="secret-role" class="role-subtext"></div>
            </div>
            <div class="card-cover">
                <span>ü§´ MANTENER</span>
            </div>
        </div>
        <button id="next-btn" class="btn-main bottom-btn" onclick="nextPlayer()">SIGUIENTE</button>
    </div>

    <div id="screen-active" class="container hidden">
        <div class="card" style="background: #233642; border: 1px solid var(--accent); text-align: center;">
            <p style="margin:0; font-size: 0.9em; color: #bdc3c7;">DEBE EMPEZAR HABLANDO:</p>
            <h2 id="starter-name" style="margin: 5px 0; font-size: 1.8em; color: #f1c40f;">...</h2>
        </div>
        <div id="timer-display" class="timer-big">10:00</div>
        <h3>¬øQui√©n es el impostor?</h3>
        <p class="instruction">Pulsa en un jugador para expulsarlo</p>
        <div id="voting-list" class="voting-grid"></div>
        <button class="btn-secondary bottom-btn" onclick="citizensGiveUp()">RENDARSE (GANA IMPOSTOR)</button>
    </div>

    <div id="screen-result" class="container hidden full-height">
        <h1 id="result-title">...</h1>
        <div id="result-icon" style="font-size: 5em; margin: 20px;"></div>
        <p id="result-msg" style="font-size: 1.2em;"></p>
        
        <div id="impostor-guess-area" class="hidden">
            <p style="color:var(--accent)">¬°√öltima oportunidad! Si adivinas la palabra, ganas.</p>
            <div style="display: grid; gap: 10px;">
                <button class="btn-main" style="background: #e74c3c;" onclick="endGameWithWinner('Impostor')">‚úÖ S√ç, LA ADIVIN√ì (Gana Impostor)</button>
                <button class="btn-secondary" onclick="endGameWithWinner('Ciudadanos')">‚ùå NO LA SABE (Ganan Ciudadanos)</button>
            </div>
        </div>

        <button id="continue-btn" class="btn-main hidden" onclick="continueGame()">SEGUIR JUGANDO</button>
    </div>

    <div id="screen-solution" class="container hidden full-height">
        <h1 id="final-result-title">PARTIDA FINALIZADA</h1>
        <div class="card">
            <h3>Palabra Secreta:</h3>
            <h1 style="color:var(--accent); font-size:3em; margin:10px 0;" id="final-word">???</h1>
        </div>
        <p id="winner-display" style="font-size: 1.5em; font-weight: bold;"></p>
        
        <button class="btn-main" onclick="restartGame()">üîÑ REINICIAR (MISMOS AJUSTES)</button>
        <button class="btn-secondary" onclick="goToHome()">üè† MEN√ö PRINCIPAL</button>
    </div>

    <script>
        let players = ['Juan', 'Mateo', 'Diego']; 
        let themes = [];
        let selectedThemesIds = [];
        let gameData = { assignments: [], currentIndex: 0, secretWord: '', secretHint: '', impostorsCaught: 0, totalImpostors: 0 };
        let timerInterval;
        let timeRemaining = 600;

        window.onload = () => {
            loadPlayers();
            fetchThemes();
            setupCardInteractions();
            updateTimeDisplay();
        };

        // --- HISTORIAL DE PARTIDAS ---
        async function loadAndShowHistory() {
            try {
                const res = await fetch('/api/history');
                const history = await res.json();
                
                const container = document.getElementById('history-list');
                if (history.length === 0) {
                    container.innerHTML = "<p>A√∫n no hay partidas registradas.</p>";
                } else {
                    container.innerHTML = history.map(game => {
                        const date = new Date(game.date).toLocaleDateString();
                        const winClass = game.winner === 'Impostor' ? 'win-impostor' : 'win-citizens';
                        const winnerText = game.winner === 'Impostor' ? 'üëë Gan√≥ Impostor' : 'üõ°Ô∏è Ganaron Ciudadanos';
                        
                        return `
                        <div class="history-item ${winClass}">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong style="font-size:1.1em; color: white;">${game.word}</strong>
                                <span class="badge" style="background:rgba(255,255,255,0.2)">${date}</span>
                            </div>
                            <div class="history-details">
                                <p style="margin:5px 0;"><strong>${winnerText}</strong></p>
                                <p style="margin:5px 0;">üòà Impostor: <span style="color:#e74c3c">${game.impostor}</span></p>
                                <p style="margin:5px 0;">üí° Pista recibida: <em>"${game.hint || 'Ninguna'}"</em></p>
                                <p style="margin:5px 0; font-size:0.85em;">üë• Jugadores: ${game.players.join(', ')}</p>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
                showScreen('screen-history');
            } catch (e) {
                alert("Error cargando historial");
            }
        }

        async function saveGameRecord(winner) {
            // Recopilar datos
            const impostorObj = gameData.assignments.find(p => p.isImpostor);
            const playerNames = gameData.assignments.map(p => p.name);
            
            const record = {
                players: playerNames,
                impostor: impostorObj ? impostorObj.name : "Desconocido",
                word: gameData.secretWord,
                hint: gameData.secretHint,
                winner: winner // 'Impostor' o 'Ciudadanos'
            };

            await fetch('/api/history', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(record)
            });
        }

        // --- FLUJO DE JUEGO & GANADORES ---

        function citizensGiveUp() {
            if(confirm("¬øRendirse? Ganar√° el Impostor.")) {
                endGameWithWinner('Impostor');
            }
        }

        function votePlayer(index) {
            if(!confirm(`¬øSeguro que quer√©is expulsar a ${gameData.assignments[index].name}?`)) return;
            const player = gameData.assignments[index];
            player.alive = false; 
            
            showScreen('screen-result');
            const title = document.getElementById('result-title');
            const icon = document.getElementById('result-icon');
            const msg = document.getElementById('result-msg');
            const impostorArea = document.getElementById('impostor-guess-area');
            const continueBtn = document.getElementById('continue-btn');

            clearInterval(timerInterval); // Pausa

            if(player.isImpostor) {
                // IMPOSTOR PILLADO -> FASE DE DECISI√ìN
                title.innerText = "¬°IMPOSTOR PILLADO!";
                title.style.color = "#2ecc71";
                icon.innerText = "üéâ";
                msg.innerText = `${player.name} era el Impostor.`;
                
                // Mostrar botones de "Adivin√≥ o no"
                impostorArea.classList.remove('hidden');
                continueBtn.classList.add('hidden');
            } else {
                // INOCENTE PILLADO -> SIGUE EL JUEGO
                title.innerText = "ERROR...";
                title.style.color = "#e74c3c";
                icon.innerText = "üíÄ";
                msg.innerText = `${player.name} NO era impostor. Era inocente.`;
                
                impostorArea.classList.add('hidden');
                continueBtn.classList.remove('hidden');
            }
        }

        function continueGame() {
            const living = gameData.assignments.filter(p => p.alive).length;
            const livingImpostors = gameData.assignments.filter(p => p.alive && p.isImpostor).length;
            
            // Si quedan 2 personas y una es impostor -> Gana Impostor por superioridad
            if(living <= 2 && livingImpostors > 0) {
                alert("¬°Quedan 2 personas! El impostor gana por empate t√©cnico.");
                endGameWithWinner('Impostor');
            } 
            // Si no quedan impostores vivos (esto no deber√≠a pasar por votePlayer, pero por seguridad)
            else if (livingImpostors === 0) {
                 endGameWithWinner('Ciudadanos');
            } 
            else {
                showScreen('screen-active');
                renderVotingList();
                // Reanudar timer si quisieras, o dejarlo pausado/continuo
            }
        }

        function endGameWithWinner(winner) {
            clearInterval(timerInterval);
            
            // Guardar en servidor
            saveGameRecord(winner);

            // Mostrar pantalla final
            document.getElementById('final-word').innerText = gameData.secretWord;
            const display = document.getElementById('winner-display');
            if(winner === 'Impostor') {
                display.innerText = "üèÜ GANA EL IMPOSTOR üèÜ";
                display.style.color = "#e74c3c";
            } else {
                display.innerText = "üõ°Ô∏è GANAN LOS CIUDADANOS üõ°Ô∏è";
                display.style.color = "#2ecc71";
            }
            showScreen('screen-solution');
        }

        // --- RESTO DE FUNCIONES (Persistencia, Temas, UI) ---
        // (Las funciones loadPlayers, savePlayers, renderPlayers, addPlayer, removePlayer, 
        // showScreen, goToHome, restartGame, fetchThemes, updateTimeDisplay, etc. 
        // SE MANTIENEN IGUAL QUE EN LA VERSI√ìN ANTERIOR)
        
        function loadPlayers() {
            const stored = localStorage.getItem('impostorPlayers');
            if (stored) {
                try { players = JSON.parse(stored); if (!Array.isArray(players) || players.length === 0) players = ['Ana', 'Juan', 'Pedro']; } 
                catch (e) {}
            }
            renderPlayers();
        }
        function savePlayers() { localStorage.setItem('impostorPlayers', JSON.stringify(players)); }
        function renderPlayers() {
            document.getElementById('players-list').innerHTML = players.map((p,i) => `<span class="tag" onclick="removePlayer(${i})">${p} ‚úï</span>`).join('');
            const maxImp = Math.max(1, Math.floor(players.length / 2));
            const impInput = document.getElementById('impostor-count'); impInput.max = maxImp; if (impInput.value > maxImp) impInput.value = maxImp;
            updateConfigDisplay();
        }
        function addPlayer() { const v = document.getElementById('new-player').value.trim(); if(v) { players.push(v); document.getElementById('new-player').value=''; savePlayers(); renderPlayers(); } }
        function removePlayer(i) { players.splice(i,1); savePlayers(); renderPlayers(); }
        function showScreen(id) { document.querySelectorAll('.container').forEach(d => d.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function goToHome() { showScreen('screen-home'); }
        function restartGame() { startGameSetup(); }
        async function fetchThemes() { const res = await fetch('/api/themes'); themes = await res.json(); }
        function updateTimeDisplay() { const v = parseInt(document.getElementById('game-timer-input').value); document.getElementById('time-display').innerText = (v > 20) ? "Infinito" : v + " min"; }
        function updateConfigDisplay() { document.getElementById('impostor-val').innerText = document.getElementById('impostor-count').value; }
        
        // Creador de Temas
        function openThemeCreator() { document.getElementById('new-theme-title').value = ''; document.getElementById('words-container').innerHTML = ''; addWordRow(); addWordRow(); addWordRow(); showScreen('screen-create-theme'); }
        function addWordRow() {
            const c = document.getElementById('words-container'); const d = document.createElement('div'); d.className = 'word-row card';
            d.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>Palabra</strong><span style="color:#e74c3c; cursor:pointer;" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</span></div><input type="text" class="input-word" placeholder="Ej: Manzana"><div style="margin-top:5px;"><small>Pistas (separadas por /):</small><input type="text" class="input-hints" placeholder="Ej: Es roja / Fruta prohibida"></div>`; c.appendChild(d);
        }
        async function saveThemeFromUI() {
            const name = document.getElementById('new-theme-title').value; if(!name) return alert("Pon t√≠tulo");
            const rows = document.querySelectorAll('.word-row'); const words = [];
            rows.forEach(r => { const t = r.querySelector('.input-word').value.trim(); const h = r.querySelector('.input-hints').value.trim(); if(t) { let ha=[]; if(h) ha=h.split('/').map(x=>x.trim()).filter(x=>x.length>0); if(ha.length===0) ha.push("Sin pista"); words.push({text:t, hints:ha}); } });
            if(words.length<4) return alert("M√≠nimo 4 palabras");
            await fetch('/api/themes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, words }) });
            alert("Tema guardado"); await fetchThemes(); showScreen('screen-home');
        }

        // Selecci√≥n
        function goToThemeSelection() { if(players.length < 3) return alert("M√≠nimo 3 jugadores"); renderThemeGrid(); showScreen('screen-themes'); }
        function renderThemeGrid() { document.getElementById('themes-grid').innerHTML = themes.map(t => `<div class="theme-box ${selectedThemesIds.includes(t.id)?'selected':''}" onclick="toggleTheme(${t.id})"><strong>${t.name}</strong><br><small>${t.words.length} palabras</small></div>`).join(''); }
        function toggleTheme(id) { selectedThemesIds.includes(id) ? selectedThemesIds = selectedThemesIds.filter(x => x !== id) : selectedThemesIds.push(id); renderThemeGrid(); }

        // Start Logic
        function startGameSetup() {
            if(selectedThemesIds.length === 0) return alert("Elige tema");
            let pool = []; themes.forEach(t => { if(selectedThemesIds.includes(t.id)) pool = pool.concat(t.words); });
            if(pool.length === 0) return alert("Temas vac√≠os");
            const sel = pool[Math.floor(Math.random() * pool.length)];
            gameData.secretWord = sel.text;
            const hintsOn = document.getElementById('hints-toggle').checked;
            if(hintsOn) {
                let ha = []; if(Array.isArray(sel.hints)) ha=sel.hints; else if(sel.hint) ha=[sel.hint]; else ha=["Sin pista"];
                gameData.secretHint = ha[Math.floor(Math.random()*ha.length)];
            } else { gameData.secretHint = null; }

            let impC = parseInt(document.getElementById('impostor-count').value); if(impC>=players.length) impC=players.length-1;
            gameData.totalImpostors = impC; gameData.impostorsCaught = 0;
            let assign = new Array(players.length).fill(null); let p=0;
            while(p<impC) { let r=Math.floor(Math.random()*players.length); if(!assign[r]) { assign[r]={isImpostor:true, name:players[r], alive:true}; p++; } }
            for(let i=0; i<players.length; i++) if(!assign[i]) assign[i]={isImpostor:false, name:players[i], alive:true};
            gameData.assignments = assign; gameData.currentIndex = 0;
            setupCardForPlayer(); showScreen('screen-reveal');
        }

        function setupCardInteractions() {
            const c = document.getElementById('magic-card');
            const show = (e) => { if(e.cancelable) e.preventDefault(); c.classList.add('revealed'); };
            const hide = (e) => { if(e.cancelable) e.preventDefault(); c.classList.remove('revealed'); };
            c.addEventListener('mousedown', show); c.addEventListener('mouseup', hide); c.addEventListener('mouseleave', hide);
            c.addEventListener('touchstart', show, {passive:false}); c.addEventListener('touchend', hide); c.addEventListener('touchcancel', hide);
        }
        function setupCardForPlayer() {
            const p = gameData.assignments[gameData.currentIndex];
            document.getElementById('current-player-display').innerText = "Turno de: " + p.name;
            const wd = document.getElementById('secret-word'); const rd = document.getElementById('secret-role');
            if(p.isImpostor) {
                wd.innerText = "üòà IMPOSTOR"; wd.style.color = "#e74c3c";
                rd.innerHTML = gameData.secretHint ? "Tu pista es:<br><strong style='color:#f1c40f'>"+gameData.secretHint+"</strong>" : "<span style='opacity:0.6'>Intenta pasar desapercibido...</span>";
            } else {
                wd.innerText = gameData.secretWord; wd.style.color = "#2ecc71"; rd.innerText = "Palabra Secreta";
            }
            const btn = document.getElementById('next-btn');
            if(gameData.currentIndex >= players.length-1) { btn.innerText = "EMPEZAR CRON√ìMETRO"; btn.onclick = startActiveGame; }
            else { btn.innerText = "SIGUIENTE JUGADOR"; btn.onclick = () => { gameData.currentIndex++; setupCardForPlayer(); }; }
        }

        function startActiveGame() {
            showScreen('screen-active'); renderVotingList();
            let pool = [];
            gameData.assignments.forEach(p => { if(p.alive) { const w = p.isImpostor ? 6 : 10; for(let i=0;i<w;i++) pool.push(p.name); } });
            document.getElementById('starter-name').innerText = pool[Math.floor(Math.random()*pool.length)];
            
            const m = parseInt(document.getElementById('game-timer-input').value);
            if(m > 20) document.getElementById('timer-display').innerText = "‚ôæÔ∏è";
            else {
                timeRemaining = m * 60; updateTimerUI();
                timerInterval = setInterval(() => { timeRemaining--; updateTimerUI(); if(timeRemaining<=0) clearInterval(timerInterval); }, 1000);
            }
        }
        function updateTimerUI() { const m=Math.floor(timeRemaining/60).toString().padStart(2,'0'); const s=(timeRemaining%60).toString().padStart(2,'0'); document.getElementById('timer-display').innerText = `${m}:${s}`; }
        function renderVotingList() {
            const c = document.getElementById('voting-list'); c.innerHTML = '';
            gameData.assignments.forEach((p,i) => {
                if(p.alive) {
                    const b = document.createElement('div'); b.className = 'vote-card'; b.innerHTML = `<strong>${p.name}</strong><br><small>Expulsar</small>`;
                    b.onclick = () => votePlayer(i); c.appendChild(b);
                }
            });
        }
    </script>
</body>
</html>